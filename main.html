<!DOCTYLE HTML>
<html>
	<head>
	<script src="jquery.js"> </script>
	<script src="notes_v2.js"> </script>
	<script>
	l = console.log;

	function drawLine(context, x1, y1, x2, y2){
		context.beginPath();
		context.moveTo(x1, y1);
		context.lineTo(x2, y2);
		context.stroke();
	};

	function drawCircle(context, x, y, radius) {
		context.beginPath();
		context.fillStyle = "white"
		context.arc(x, y, radius, 0, Math.PI*2);
		context.fill();
		context.stroke();
	};

	function FretNote(note, interval, fret, strng, x, y, radius ) {
		this.note = note;
		this.interval = interval;
		this.fret = fret;
		this.strng = strng;
		this.x = x;
		this.y = y;
		this.radius = radius;
	};

	function GuitarString(root, frets) {
		this.root = new Note(root);
		this.frets = frets;
		this.highest = this.root + new Interval(frets);

		this.at_fret = function(fret) {
			return this.root.add(new Interval(fret));
		}
	};

	function Fretboard(renderer) {
		this.fret_count = 21;
		this.strings = ["E2", "A2", "D3", "G4", "B4", "E5"].map(function(a) { return new GuitarString(a, this.fret_count) });

		this.getScale = function(scale, start_fret, end_fret) {
			var fretNotes = [];
			var root = scale.root;
			var intervals = scale.formula.intervals;
			var shape_size = end_fret - start_fret;
			for (var pos=0; pos<shape_size*this.strings.length; pos++) {
				var fret = start_fret+(pos%shape_size);
				var strng = Math.floor(pos/shape_size);
				var cursor_note = this.strings[strng].at_fret(fret);

				for(var i=0; i<intervals.length; i++) {
				var scale_note = root.add(intervals[i]);
				if (cursor_note.semitones() == scale_note.semitones()) {
					var position = this.renderer.getPos(strng, fret);
					var x = position[0];
					var y = position[1];
					var radius = this.renderer.calcNoteSize(fret);
					fretNotes.push(new FretNote(cursor_note, intervals[i], fret, strng, x, y, radius));
					}
				}
			}
			return fretNotes;
		}
	}

	function NoteRenderer(context) {
		this.context = context;
		this.draw = function(notes){
			for(i=0; i<notes.length; i++) {
				var note = notes[i];
				drawCircle(this.context, note.x, note.y, note.radius);

			}
		}
	}
	function FretboardRenderer(context, fretboard) {
		this.context = context;
		this.fretboard = fretboard;
		this.fretboard.renderer = this;

		this.fret_count = this.fretboard.fret_count;
		this.string_count = this.fretboard.strings.length;

		this.left = 100;
		this.top = 30;
		this.width = 1300;
		this.height = 150;
		this.right = this.left + this.width;
		this.bottom = this.top + this.height;

		this.padding_top = 20;
		this.padding_bottom = 20;
		this.padding_left = 20;
		this.padding_right = 20;

		this.frets_overhang = 3;

		this.strings_top = this.top+this.padding_top;
		this.strings_left = this.left + this.padding_left;
		this.strings_right = this.right - this.padding_right;
		this.strings_bottom = this.bottom - this.padding_bottom;
		this.strings_length = this.strings_right - this.strings_left;
		this.strings_height = this.strings_bottom - this.strings_top;
		this.strings_spacer = this.strings_height/(this.string_count-1)

		this.frets_top = this.strings_top - this.frets_overhang;
		this.frets_bottom = this.strings_bottom + this.frets_overhang;

		this.frets_open_position = -15;

		this.frets_open_width = 90;

		this.finger_min_margin = 2; //Gap between adjacent dots
		this.finger_max_size = this.strings_spacer/2 - this.finger_min_margin;
		this.finger_start_radius = 20; //Percentages of fret width
		this.finger_end_radius =  40;

		this.single_inlay_frets = [3, 5, 7, 9, 15, 17, 19];
		this.double_inlay_frets = [12, 24];
		this.inlay_radius = 5;

		this.init = function(){
			//Fret positions & Finger positions
			var frets = this.fret_count;
			var scale_length = this.strings_length * Math.pow(2, frets/12) / (Math.pow(2, frets/12) - 1);
			this.fret_position = [0];
			this.finger_position = [this.frets_open_position];
			this.inlay_position = [0];
			this.fret_width = [this.frets_open_width];
			for (i=1; i<frets; i++){
				this.fret_position[i] = scale_length - (scale_length / Math.pow(2, i/12));
				this.fret_position[i] = Math.round(this.fret_position[i]);
				var curFret = this.fret_position[i];
				var prevFret = this.fret_position[i-1];
				var fretWidth = curFret - prevFret;
				this.fret_width[i] = fretWidth;
				var fretCenter = prevFret + fretWidth/2;
				this.finger_position[i] = fretCenter;
				this.inlay_position[i] = fretCenter;
			}
			//String Positions
			this.string_position = []
			for (var i=0; i<this.string_count; i++) {
				this.string_position[i] = this.strings_spacer*i;
			}
		};

		this.drawFrets = function(){
			for (var i=0; i<this.fret_position.length; i++) {
				var x = this.fret_position[i] + this.strings_left;
				drawLine(this.context, x, this.frets_top, x, this.frets_bottom);
			}
		};

		this.drawStrings = function() {
			for (var i=0; i<this.string_count; i++) {
				var y = this.string_position[i] + this.strings_top;
				drawLine(this.context, this.strings_left, y, this.strings_right, y);
			}
		};

		this.drawSingleInlay = function(i) {
			x = this.strings_left + this.inlay_position[i];
			y = this.strings_top + this.strings_height/2;
			drawCircle(this.context, x, y, this.inlay_radius);
		}
		this.drawDoubleInlay = function(i) {
			x = this.strings_left + this.inlay_position[i];
			y1 = this.strings_top + this.strings_height/3;
			y2 = this.strings_top + (this.strings_height/3)*2;
			drawCircle(this.context, x, y1, this.inlay_radius);
			drawCircle(this.context, x, y2, this.inlay_radius);
		}
		this.drawInlays = function() {
			for (i=0; i<this.fret_count; i++) {
				if (i in this.single_inlay_frets)
					this.drawSingleInlay(this.single_inlay_frets[i])
				if (i in this.double_inlay_frets)
					this.drawDoubleInlay(this.double_inlay_frets[i])
			}
		}


		this.calcNoteSize = function(fret_no) {
			var width = this.fret_width[fret_no]/2;
			var min_percent = this.finger_start_radius;
			var max_percent = this.finger_end_radius;
			var percent_difference = (max_percent - min_percent)/this.fret_count;
			var current_percent = min_percent  + percent_difference * i;

			var radius = (width/100)*current_percent;
			if (radius > this.finger_max_size) radius =  this.finger_max_size;
			return radius;
		};

		this.getPos = function(string_no, fret_no) {
			string_no = this.string_count -1 - string_no
			return [this.finger_position[fret_no] + this.strings_left, this.string_position[string_no] + this.strings_top]
		}

	}


function hexCounter(value) {
	value = Math.floor(255*Math.min(value,1));
	str = value.toString(16)
	return "#"+str+str+str;
}

function animateNote(context, duration, note) {
	var start = new Date().getTime();
	var end = start + duration;
	var context = context;
	var step = function() {
		var timestamp = new Date().getTime();
		var progress = Math.min((duration - (end - timestamp)) / duration, 1)

		if (progress < 0.4) 
			var c_val = Math.round(Math.cos(progress*Math.PI/3)*100)/100;
		else
			var c_val = Math.round(Math.sin(progress*Math.PI/2)*100)/100;


		var fs = hexCounter(c_val);

		context.fillStyle = "#fff";
		context.beginPath();
		context.arc(note.x, note.y, note.radius+1, 0, Math.PI*2);
		context.closePath();
		context.fill();

		var rad = note.radius;
		context.beginPath();
		context.fillStyle = fs;
		context.arc(note.x, note.y, rad, 0, Math.PI*2);
		context.closePath();
		context.fill();

		context.beginPath();
		context.arc(note.x, note.y, rad, 0, Math.PI*2);
		context.closePath();
		context.stroke();

		if (progress < 1) {
			requestAnimationFrame(step);
		}
	}
	step();
}

	$(document).ready(function() {
		var canvas = document.getElementById('canvas');
		var context = canvas.getContext('2d');

		context.font = '40pt Calibri';
		context.fillStyle = 'blue';
		//context.fillText('Hello World!', 50, 100);
		var requestAnimationFrame = window.requestAnimationFrame || 
									window.mozRequestAnimationFrame || 
									window.webkitRequestAnimationFrame || 
									window.msRequestAnimationFrame;

		fretboard = new Fretboard();
		fb_rend = new FretboardRenderer(context, fretboard);
		fb_rend.init();
		fb_rend.drawInlays();
		fb_rend.drawFrets();
		fb_rend.drawStrings();
		//a.drawAllNotes();
		var scale = new Scale(new Note("A2"), new ScaleFormula("1 b3 b5 bb7"))
		fretboard.getScale(scale)
		note_rend = NoteRenderer(context);
		notes = fretboard.getScale(scale, 5, 9);
		note_rend,draw(notes);
		var i=0;
		var dir = 1;
		window.setInterval(function() {
			animateNote(context, 800, notes[i]);
			i = (i+dir);
			if (i == notes.length-1) dir = -dir;
			if (i == 0 && dir ==-1) dir = -dir;
		}, 600);
	});
	</script>
	</head>
	<body>
		<canvas id="canvas" width=1500 height=1000> </canvas>
	</body>
</html>
